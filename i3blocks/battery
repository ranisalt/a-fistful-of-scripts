#!/usr/bin/env sh

INSTANCE=${BLOCK_INSTANCE:-0}
BAT_PATH="/sys/class/power_supply/BAT$INSTANCE"

# As per #36 -- It is transparent: e.g. if the machine has no battery or wireless
# connection (think desktop), the corresponding block should not be displayed.
[[ ! -d "$BAT_PATH" ]] && exit

EN_NOW=$(cat $BAT_PATH/energy_now)
EN_FULL=$(cat $BAT_PATH/energy_full)
PW_NOW=$(cat $BAT_PATH/power_now)
PERCENT=$(echo "scale=2; 100.0 * $EN_NOW / $EN_FULL" | bc)
if [ $PW_NOW -eq 0 ]; then
    REMAINING="FULL"
else
    REMAINING=$(date '+%T' -u -d '@'`expr 3600 \* $EN_NOW / $PW_NOW`)
fi

echo "$PERCENT% ($REMAINING)"
echo "$PERCENT% ($REMAINING)"

if [ $(cat $BAT_PATH/status) = "Charging" ]; then
    echo "#00FF00"
    exit
fi

if [ $(echo "$PERCENT < 5" | bc) -eq 1 ]; then
    echo "#FF0000"
elif [ $(echo "$PERCENT < 10" | bc) -eq 1 ]; then
    echo "#FFAE00"
elif [ $(echo "$PERCENT < 15" | bc) -eq 1 ]; then
    echo "#FFF600"
fi
